---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroBlock from '../components/blocks/HeroBlock.astro';
import FeaturesBlock from '../components/blocks/FeaturesBlock.astro';
import TestimonialsBlock from '../components/blocks/TestimonialsBlock.astro';
import MarkdownBlock from '../components/blocks/MarkdownBlock.astro';
import CtaBlock from '../components/blocks/CtaBlock.astro';
import FaqBlock from '../components/blocks/FaqBlock.astro';
import { db } from '../lib/db';
import { pages, blocks } from '@liteshow/db/src/content-schema';
import { eq } from 'drizzle-orm';

// Generate static paths at build time
export async function getStaticPaths() {
  // Fetch all published pages
  const allPages = await db
    .select()
    .from(pages)
    .where(eq(pages.status, 'published'));

  return allPages.map(page => ({
    params: { slug: page.slug },
    props: { page },
  }));
}

const { page } = Astro.props;

// Fetch blocks for this page
const pageBlocks = await db
  .select()
  .from(blocks)
  .where(eq(blocks.pageId, page.id))
  .orderBy(blocks.order);

// Parse block content
const parsedBlocks = pageBlocks.map(block => ({
  ...block,
  content: typeof block.content === 'string' ? JSON.parse(block.content) : block.content
}));

const blockComponents: Record<string, any> = {
  hero: HeroBlock,
  features: FeaturesBlock,
  testimonials: TestimonialsBlock,
  markdown: MarkdownBlock,
  cta: CtaBlock,
  faq: FaqBlock,
};
---

<BaseLayout
  title={page.metaTitle || page.title}
  description={page.metaDescription || page.description || undefined}
  ogImage={page.ogImage || undefined}
>
  <main>
    {parsedBlocks.map((block: any) => {
      const Component = blockComponents[block.type];
      if (!Component) {
        console.warn(`Unknown block type: ${block.type}`);
        return null;
      }
      return <Component content={block.content} />;
    })}
  </main>
</BaseLayout>
