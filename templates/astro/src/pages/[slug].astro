---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroBlock from '../components/blocks/HeroBlock.astro';
import CtaBlock from '../components/blocks/CtaBlock.astro';
import MarkdownBlock from '../components/blocks/MarkdownBlock.astro';
import FeaturesBlock from '../components/blocks/FeaturesBlock.astro';
import TestimonialsBlock from '../components/blocks/TestimonialsBlock.astro';
import FaqBlock from '../components/blocks/FaqBlock.astro';
import { getPage, getAllPages, getSiteSettings } from '../lib/content-api';

// Generate static paths for all published pages at build time
export async function getStaticPaths() {
  const pages = await getAllPages();
  return pages.map((page) => ({
    params: { slug: page.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

const page = await getPage(slug);

if (!page) {
  return Astro.redirect('/404');
}

const siteSettings = await getSiteSettings();
---

<BaseLayout
  title={page.seo_title || page.title}
  description={page.seo_description}
  keywords={page.seo_keywords}
  faviconUrl={siteSettings?.faviconUrl}
>
  {page.blocks.map((block) => {
    switch (block.type) {
      case 'hero':
        return (
          <HeroBlock
            headline={block.content.headline as string}
            subheadline={block.content.subheadline as string}
            ctaText={block.content.ctaText as string}
            ctaUrl={block.content.ctaUrl as string}
          />
        );
      case 'cta':
        return (
          <CtaBlock
            headline={block.content.headline as string}
            body={block.content.body as string}
            buttonText={block.content.buttonText as string}
            buttonUrl={block.content.buttonUrl as string}
          />
        );
      case 'markdown':
        return <MarkdownBlock markdown={block.content.markdown as string} />;
      case 'features':
        return <FeaturesBlock content={block.content as any} />;
      case 'testimonials':
        return <TestimonialsBlock content={block.content as any} />;
      case 'faq':
        return <FaqBlock content={block.content as any} />;
      default:
        return null;
    }
  })}
</BaseLayout>
